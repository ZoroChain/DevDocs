# ZoroChain的代码变更记录

## 应用链的运行机制（新增）
* 应用链的核心机制
  * 为每条应用链建立一套独立的P2P网络，LevelDB数据库以及对应的一整套Actor对象（LocalNode, Blockchain, TaskManager等）
  * 可以在运行时启动和关闭某一条应用链，或者是启动或关闭应用链的共识服务  
* 应用链的状态存储
  * 增加应用链的State用来存储应用链的相关信息
* 应用链的建立和变更
  * 增加对应的SysCall，实现创建和变更应用链的相关功能
  * 实现在运行时更改应用链的共识节点和种子节点的功能
* 应用链的侦听和启动
  * 首先判断是否是应用链的共识节点和种子节点
  * 再基于配置表里的应用链名称和Hash来判断
* 增加查询应用链信息的相关Rpc指令

## 共识流程的改动
* 弹性时间出块机制
  * 最短出块时间改为1秒，到达15秒时强制出块
  * 启示轮的共识超时时间改为30秒
* 视图切换机制的变更
  * 只有在收到的视图切换请求数量超过M时才更改本地的视图编号（M=共识节点数量 - (共识节点数量-1)/3)
  * 视图的等待时间由指数增长改为线性增长
  * 避免视图切换后，每轮共识的等待时间增长过大
* 缓存超前的共识消息
  * 当收到的共识消息的高度大于当前链的高度时，先缓存该消息，等到本地共识节点的高度赶上时，再处理缓存的消息
  * 当共识节点之间因为处理速度和网络带宽导致发生高度不统一时，能有效提高共识流程的效率

## UTXO模型相关代码的删减
* 交易相关的代码删减
  * Input, Output
  * Reference
  * UnspentCoin, SpentCoin
* 钱包索引的代码删减
  * 去掉了所有WalletIndex相关的代码
* 账户状态和全局资产的代码删减
  * Account相关的代码
  * Asset相关的代码
* SysCall的代码删减
  * 删除了以上相关功能的SysCall函数  

## 交易结构和手续费相关的改动
* 交易结构体的改动
  * 删除了UTXO模型相关的交易，只保留了MinerTransaction和InvocationTransaction两种交易结构
  * InvocationTransaction结构增加GasPrice和GasLimit，实现类似以太坊的手续费定价机制
* 手续费扣关机制的改动
  * 在交易上链时，先预扣出金额为GasLimit的手续费，等交易运行后，再按实际消耗的Gas，退回多扣的手续费
  * 在交易上链时，如果消耗的手续费超过GasLimit时，交易执行失败，但已消耗的手续费不退回
  * 在交易上链时，如果交易执行失败，但消耗的手续费没有超过设置的GasLimit，返回已消耗的手续费
* 矿工奖励手续费的流程改动
  * 在MinerTransaction里只记录矿工的账户地址，不再记录奖励给矿工的Gas金额
  * 在新块上链时，等所有交易都执行完成后计算出手续费总和，转账给矿工，并记录相关日志
* 手续费定价的改动
  * 修改了相关方法的手续费价格

## NativeNEP5机制（新增）
* 模仿NEP5的功能，用C#实现NEP5 Token的相关功能
* 用SysCall来提供发布NativeNEP5的方法
* 用SysCall来提供NativeNEP5相关方法的调用接口
* NativeNEP5的手续费按照每个方法来单独设定

## 全局资产和创世块的改动
* 用BCP和BCT来替代NEO创世块里的NEO和GAS
* 用NativeNEP5来定义BCP和BCT
* 定义在创世块中的Token即为全局资产，可以在所有应用链上直接使用

## 交易分发流程的改动
* 交易的缓存和分发
  * 节点在收到新交易后，不再立刻转发给其他节点，而是先缓存在本地
  * 如果缓存的交易数量超过500个，或者交易体的字节数超过256KB，则立刻转发
  * 否则每隔100毫秒进行一次分发
  * 批量转发前，先对交易数据进行压缩
* 作用：降低网络传输量，提高节点间交易池的同步效率

## 交易接收和重新验证流程的更改
* MemPool的代码改动
  * 去掉免费交易队列，只保留付费交易队列
  * 打包交易时，按照GasPrice从高到低的优先级挑选交易
  * 交易池满以后，高价交易可以套改低价交易  

## 网络数据同步监控
* 增加区块，交易，共识数据收发的计数和超时
* 增加cli的显示监控指令，能实时显示每个远程节点的数据收发统计和超时情况

## 区块和交易数据同步流程的改动
* 按照远程节点的收发计数统计，均衡的在远程节点之间轮循发送同步请求
* 避免之前的重复请求相同区块数据的问题

## RpcAgent插件和RpcHost程序
* 目的：将Rpc处理程序从cli节点中分离出来，成为一个独立的进程
* 方案：Rpc处理程序在收到Http请求后，用Socket将请求转发给cli处理，再将cli传回的结果发到给客户端
* RpcAgent：Socket服务器，接收RpcHost的连接，处理其发来的Http请求
* RpcHost：提供HttpServer的服务，接收客户端发来的请求，并反馈处理结果

## StressTesting插件
* 并发转账交易测试程序
  * 绕开Rpc，直接向本地节点发起并发转账交易
  * 可以选择转账交易的类型，包括NativeNEP5或NEP5
  * 可以配置每秒并发的交易数量和总共的交易数量
  * 可以向多个虚拟账户地址发交易
  * 可以随机GasPrice，测试交易池满以后低价交易被高价交易淘汰的情况

## 细微修改
* 修改了因为getdata消息包不被重复接收导致的请求数据超时的问题
* 用InvokeScript方式运行合约，执行到CheckWitness时，能跳过该方法不再报错
* 增加了Ping/Pong消息用来实时更新远程节点的高度和网络延迟
