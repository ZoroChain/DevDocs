# ZoroChain的工作机制（讨论稿）
#### 根链和应用链
* 根链做为管理链，负责所有应用链管理，以及全局资产管理
* 每个上链的应用有专属的一条应用链，负责记录和该应用有关的所有交易

#### 创建应用链
* 创建应用链需要一定的系统费用
* 用交易记账的流程来创建应用链
* 某个节点收到一个创建应用链的交易请求
* 该节点广播该交易并等待共识
* 共识节点通过共识后，将该交易写入根链
* 其他节点在同步根链时，能获知当前已建立的所有应用链的信息

#### 创建应用链消息
* 创建应用链的消息需要包括以下内容
  * 应用链的名称和Hash
  * 网络端口号，包括TCP和WebSocket
  * 记账人账户地址，最少4个
  * 种子节点的域名

#### 验证创建应用链的消息
* 应用链的Hash必须唯一，名称可以重复
* 网络端口不必唯一，可以和其他应用重复
* 不验证种子节点和记账人节点是否有效

#### 多个应用链的端口重复
* 应用链的端口可以和其他应用相同
* 同一个节点上不允许跑两个端口重复应用
* 在后续版本中会优化P2P网络的连接结构，并去掉上面这个限制

#### 删除应用链
* 暂时不提供删除应用链的操作

#### 根链的记账备选人
* 采用类似NEO的机制，由官方指定N个备选人
* 暂时不做投票选举其他账户作为备选人的功能

#### 应用链的记账备选人
* 由应用链的创建者指定，最少4个
* 第一个版本中，只有应用链的创建者可以修改备选人
* 后续版本中会加入权限管理，由应用链的管理员来修改备选人

#### 应用链的管理权限
* 第一个版本中不做，后续版本中加入
* 应用链会有一套操作权限管理机制，例如更改记账人、更改记账费率、更改管理员权限等
* 应用链的创建者会成为默认的超级管理员，拥有全部操作的权限以及对其他管理员的管理权限
* 在第一个版本中，所有涉及到权限的操作，只有应用链的创建者可以发起

#### 应用链的交易费用
* 每个应用链有一个GasCoinPool，在该链进行共识出块时，会从GasCoinPool中扣掉所有需要记账的交易的费用总和
* 如果GasCoinPool中的金额不够支付记账费用，则无法进行共识出块
* 扣除的记账费用，会按预定规则分配给参与本次共识的记账人节点（先按照平均分配的方式）
* 每个应用链可以自主设定记账费用相对于Zoro BCP的兑换比例，以此控制本应用链的记账费用高低，吸引更多的矿工节点参与记账

#### 节点配置需要关注的应用链
* 每个节点可以在配置文件中自由配置需要关注的应用链
* 节点启动后可以用指令动态更改自身关注的应用链，对应的列表会被保存到配置文件中
* 节点启动后，先同步根链的区块，之后会同步关注的应用链区块

#### 节点配置参与应用链的记账
* 每个节点可以在配置文件中指定是否要参与某个应用链的记账
* 配置了要参与记账的节点，必须是该应用链的记账备选人，否则还是无法参与记账
* 在创建应用链时，指定了默认的记账备选人，之后应用链的创建者可以修改备选人

#### P2P网络的连接结构
* 每条应用链在创建时，需要指定一个网络端口
* 为每一种应用链单独组建一套P2P网络，避免一条应用链阻塞后对其他应用链造成影响
* 理论上每个节点关注的应用链数量不会太多（最多5个左右），因此每个节点连接数量也不会太多
 
#### 数据存储的机制
* 每一条链会有一个对应的LevelDB数据库，在各自独立的线程里进行数据存储

#### 根链的创世块
* 采用和NEO相同的机制，每个节点在启动后，如果数据库中没有数据则立刻创建并保存创世块
* 在根链的创世块里不进行Zoro BCP的初始登记和分配

#### 应用链的创世块
* 应用链上出的第一个块是创世块
* 应用链的创世块只是用作标记该应用链生效，不包括货币的登记和分发交易 
* 其他节点同步到应用链的创世块后，认为该应用链已开始工作

#### 是否需要定时出块
* 设定最短出块时间和最长出块时间
* 如果有交易要出块，就在到达最短时间时出块
* 如果一直没有交易要，在到达最长出块时间时也会出块

#### 合约的发布和调用
* 发布合约时需要指定发布到哪条链上
* 调用合约时只能调用本链上的合约，不能跨链调用合约

#### 程序版本升级的相关问题
* 参照NEO的方案，不同版本的节点可以在同一个P2P网络里运行
* 如果有修改到网络消息结构，需要让所有节点都更新到最新版本才能运行
* 如果有数据存储格式上的修改，不需要强制更新所有节点
  * 因为每个节点各自存储和读取数据，所以不会造成影响

#### 根链和应用链的货币
* 根链和应用链都使用NEP5标准的货币
* 根链的NEP5货币，即BCP，由官方部署发布
* 应用链的货币由应用链的创建者部署发布

#### 每个节点的交易执行结果要始终保持一致
* NEO中会有因为修改了关键程序代码，但没有强制更新所有节点，导致不同节点的交易结果不同，产生数据不同步的问题
* 我们需要确定一种能有效预防这类问题的方法

#### 根链的交易费用
* 为了防止大量无意义的交易攻击，在根链上发起交易时需要花费一定的费用
* 每个交易会计算交易类型和合约脚本的指令条数计算所需要的系统费用（类似NEO中交易所需的gas费用）
* 用户在发起交易时，可以设定一个转换系数，最终该交易的系统费用 = gas费用 * 转换系数

### 应用链的信息记录
* 增加一个叫AppChainState的数据状态类，用来在LevelDB中存储应用链的信息
* AppChainState里记录的数据包括：名称、Hash、创建者、创建日期、网络端口号、种子节点地址、备选记账人地址

### 创建应用链的AppCall
* 增加一个名为"Zoro.AppChain.Create"的AppCall，在创建应用链时调用
* 该AppCall内部会创建一个AppChainState，用于记录应用链的相关信息

### 管理应用链的AppCall
* 增加一个名为"Zoro.AppChain.SetState"的AppCall，提供更改备选记账人地址，更改种子节点等相关的功能
* 该AppCall内部会通过修改AppChainState数据来更改应用链的各类信息
* 考虑到变更端口号的复杂性，目前版本暂时不提供该功能

## 待讨论

### BCP的跨链兑换机制

### ZoroChain的BCP分红机制
